<!doctype html>
<html data-reactroot="" lang="en"><head><title>Joel Vandiver 2 / Joel Vandiver&#x27;s Blog</title></head><body><h1><a name="F-JSON-List-Deserialization" class="anchor" href="#F-JSON-List-Deserialization">F# JSON List Deserialization</a></h1>
<p>F# promotes immutability and deemphasizes null checks that plague object oriented languages.
However, though this is a guiding principle in coding in F#, F# does have some limitations.  Typically, these limitations arise at the boundaries of the system.</p>
<p>Transferring messages via JSON over HTTP is one such example of a boundary that
presents a limitation in F#.</p>
<p><strong>Limitation</strong>:  F# Lists are sometimes deserialized as null, and F# states that a list
does not have 'null' as a proper value.</p>
<p>This limitation arose from an assumption I had when using the Newtonsoft deserializer:</p>
<blockquote>
<p><strong>Lists should default to an empty list during JSON Deserialization.</strong></p>
</blockquote>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l"> 1: </span>
<span class="l"> 2: </span>
<span class="l"> 3: </span>
<span class="l"> 4: </span>
<span class="l"> 5: </span>
<span class="l"> 6: </span>
<span class="l"> 7: </span>
<span class="l"> 8: </span>
<span class="l"> 9: </span>
<span class="l">10: </span>
<span class="l">11: </span>
<span class="l">12: </span>
<span class="l">13: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span class="pp">#r</span> <span class="s">@&quot;C:\Users\joelv\.nuget\packages\NETStandard.Library\2.0.3\build\netstandard2.0\ref\netstandard.dll&quot;</span>
<span class="pp">#r</span> <span class="s">@&quot;C:\git\joelvandiver.github.io\packages\Newtonsoft.Json\lib\netstandard2.0\Newtonsoft.Json.dll&quot;</span>

<span class="k">open</span> <span onmouseout="hideTip(event, '1', 1)" onmouseover="showTip(event, '1', 1)" class="id">System</span>
<span class="k">open</span> <span class="id">Newtonsoft</span><span class="pn">.</span><span class="id">Json</span>

<span class="k">type</span> <span onmouseout="hideTip(event, '2', 2)" onmouseover="showTip(event, '2', 2)" class="rt">A</span> <span class="o">=</span> 
   <span class="pn">{</span>  <span onmouseout="hideTip(event, '3', 3)" onmouseover="showTip(event, '3', 3)" class="id">Title</span><span class="pn">:</span> <span onmouseout="hideTip(event, '4', 4)" onmouseover="showTip(event, '4', 4)" class="rt">string</span>
      <span onmouseout="hideTip(event, '5', 5)" onmouseover="showTip(event, '5', 5)" class="id">Items</span><span class="pn">:</span> <span onmouseout="hideTip(event, '4', 6)" onmouseover="showTip(event, '4', 6)" class="rt">string</span> <span onmouseout="hideTip(event, '6', 7)" onmouseover="showTip(event, '6', 7)" class="rt">list</span> <span class="pn">}</span>

<span class="k">let</span> <span onmouseout="hideTip(event, '7', 8)" onmouseover="showTip(event, '7', 8)" class="id">json</span> <span class="o">=</span> <span class="s">&quot;&quot;&quot;{ &quot;Title&quot;: &quot;JSON A&quot; }&quot;&quot;&quot;</span>

<span class="k">let</span> <span onmouseout="hideTip(event, '8', 9)" onmouseover="showTip(event, '8', 9)" class="id">itemsIsNull</span> <span class="o">=</span> <span class="id">JsonConvert</span><span class="pn">.</span><span class="id">DeserializeObject</span><span class="pn">&lt;</span><span onmouseout="hideTip(event, '2', 10)" onmouseover="showTip(event, '2', 10)" class="id">A</span><span class="pn">&gt;</span><span class="pn">(</span><span onmouseout="hideTip(event, '7', 11)" onmouseover="showTip(event, '7', 11)" class="id">json</span><span class="pn">)</span>
</code></pre></td>
</tr>
</table>
<p><em>Output:</em></p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l">1: </span>
<span class="l">2: </span>
</pre></td>
<td class="snippet"><pre class="fssnip"><code lang="console">val itemsIsNull : A = {Title = "JSON A";
                        Items = null;}
</code></pre></td></tr></table>
<h3><a name="Problem-1-Use-of-the-List-will-lead-to-an-Object-NullReferenceException" class="anchor" href="#Problem-1-Use-of-the-List-will-lead-to-an-Object-NullReferenceException">Problem 1 - Use of the List will lead to an Object NullReferenceException.</a></h3>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l">1: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span class="k">let</span> <span class="id">willThrow</span> <span class="o">=</span> <span class="id">itemsIsNull</span><span class="pn">.</span><span class="id">Items</span><span class="pn">.</span><span class="id">Length</span>
</code></pre></td>
</tr>
</table>
<p><em>Output:</em></p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l">1: </span>
<span class="l">2: </span>
<span class="l">3: </span>
<span class="l">4: </span>
</pre></td>
<td class="snippet"><pre class="fssnip"><code lang="console">System.NullReferenceException: Object reference not set to an instance of an object.
   at &lt;StartupCode$FSI_0007&gt;.$FSI_0007.main@() in 
   c:\git\joelvandiver.github.io\posts\explorations\ideas\json-list-deserialization\index.fsx:line 170
Stopped due to error
</code></pre></td></tr></table>
<h3><a name="Problem-2-Null-lists-cannot-be-checked-for-null-directly" class="anchor" href="#Problem-2-Null-lists-cannot-be-checked-for-null-directly">Problem 2 - Null lists cannot be checked for null directly.</a></h3>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l">1: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span class="k">let</span> <span class="id">willNotCompile</span> <span class="o">=</span> <span class="id">itemsIsNull</span><span class="pn">.</span><span class="id">Items</span> <span class="o">=</span> <span class="k">null</span>
</code></pre></td>
</tr>
</table>
<p><em>Output:</em></p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l">1: </span>
</pre></td>
<td class="snippet"><pre class="fssnip"><code lang="console">index.fsx(28,42): error FS0043: The type 'string list' does not have 'null' as a proper value
</code></pre></td></tr></table>
<hr />
<h3><a name="Solution-1-Use-Object-ReferenceEquals-to-Check-for-Null" class="anchor" href="#Solution-1-Use-Object-ReferenceEquals-to-Check-for-Null">Solution 1 - Use Object.ReferenceEquals to Check for Null</a></h3>
<p><em>Drawback</em> -&gt; Implementation code is littered with noisy code.</p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l">1: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span class="k">let</span> <span onmouseout="hideTip(event, '9', 12)" onmouseover="showTip(event, '9', 12)" class="id">willBeNull</span> <span class="o">=</span> <span onmouseout="hideTip(event, '10', 13)" onmouseover="showTip(event, '10', 13)" class="rt">Object</span><span class="pn">.</span><span onmouseout="hideTip(event, '11', 14)" onmouseover="showTip(event, '11', 14)" class="id">ReferenceEquals</span><span class="pn">(</span><span onmouseout="hideTip(event, '8', 15)" onmouseover="showTip(event, '8', 15)" class="id">itemsIsNull</span><span class="pn">.</span><span onmouseout="hideTip(event, '5', 16)" onmouseover="showTip(event, '5', 16)" class="id">Items</span><span class="pn">,</span> <span class="k">null</span><span class="pn">)</span>
</code></pre></td>
</tr>
</table>
<p><em>Output:</em></p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l">1: </span>
</pre></td>
<td class="snippet"><pre class="fssnip"><code lang="console">val willBeNull : bool = true
</code></pre></td></tr></table>
<hr />
<h3><a name="Solution-2-Change-the-Type-Definition-to-Allow-Option-Types" class="anchor" href="#Solution-2-Change-the-Type-Definition-to-Allow-Option-Types">Solution 2 - Change the Type Definition to Allow Option Types</a></h3>
<p><em>Drawback</em> -&gt; Ambiguity is added to the system about the purpose of the optional list.</p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l">1: </span>
<span class="l">2: </span>
<span class="l">3: </span>
<span class="l">4: </span>
<span class="l">5: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span class="k">type</span> <span onmouseout="hideTip(event, '12', 17)" onmouseover="showTip(event, '12', 17)" class="rt">B</span> <span class="o">=</span>
   <span class="pn">{</span>  <span onmouseout="hideTip(event, '13', 18)" onmouseover="showTip(event, '13', 18)" class="id">Title</span><span class="pn">:</span> <span onmouseout="hideTip(event, '4', 19)" onmouseover="showTip(event, '4', 19)" class="rt">string</span>
      <span onmouseout="hideTip(event, '14', 20)" onmouseover="showTip(event, '14', 20)" class="id">Items</span><span class="pn">:</span> <span onmouseout="hideTip(event, '4', 21)" onmouseover="showTip(event, '4', 21)" class="rt">string</span> <span onmouseout="hideTip(event, '6', 22)" onmouseover="showTip(event, '6', 22)" class="rt">list</span> <span onmouseout="hideTip(event, '15', 23)" onmouseover="showTip(event, '15', 23)" class="rt">option</span> <span class="pn">}</span>

<span class="k">let</span> <span onmouseout="hideTip(event, '16', 24)" onmouseover="showTip(event, '16', 24)" class="id">itemsIsNone</span> <span class="o">=</span> <span class="id">JsonConvert</span><span class="pn">.</span><span class="id">DeserializeObject</span><span class="pn">&lt;</span><span onmouseout="hideTip(event, '12', 25)" onmouseover="showTip(event, '12', 25)" class="id">B</span><span class="pn">&gt;</span><span class="pn">(</span><span onmouseout="hideTip(event, '7', 26)" onmouseover="showTip(event, '7', 26)" class="id">json</span><span class="pn">)</span>
</code></pre></td>
</tr>
</table>
<p><em>Output:</em></p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l">1: </span>
<span class="l">2: </span>
</pre></td>
<td class="snippet"><pre class="fssnip"><code lang="console">val itemsIsNone : B = {Title = "JSON A";
                       Items = None;}
</code></pre></td></tr></table>
<hr />
<h3><a name="Solution-3-Configure-the-Deserializer-to-Provide-the-Empty-List" class="anchor" href="#Solution-3-Configure-the-Deserializer-to-Provide-the-Empty-List">Solution 3 - Configure the Deserializer to Provide the Empty List</a></h3>
<p><em>Drawback</em> -&gt; Difficult</p>
<p>// TODO:  Add support for Empty Lists in the Deserializer</p>
<hr />
</body></html>